- &hcp_test
  id: fetch_hcp
  structure:
    samples.yaml: |
      - id: BACKUP
        files:
        - input/BACKUP
        hcp_remote_keys:
        - BACKUP
  external:
    ..: modules/hcp
  mocks:
    modules.hcp.src.util.HCPManager: ~
  args:
    --samples_file: samples.yaml
    --workdir: work
    --hcp_credentials: "DUMMY"
  logs:
    - Fetched BACKUP from hcp

- <<: *hcp_test
  id: no_backup
  structure:
    samples.yaml: |
      - id: NO_BACKUP
        files:
        - input/NO_BACKUP
  logs:
    - No backup for NO_BACKUP

- <<: *hcp_test
  id: skip_present
  structure:
    samples.yaml: |
      - id: PRESENT
        files:
        - input/PRESENT
        hcp_remote_keys:
        - PRESENT
    input:
      PRESENT: PRESENT
  logs:
    - Found all files for PRESENT locally

- <<: *hcp_test
  id: not_configured
  args:
    --workdir: work
  logs:
  - HCP not configured

- <<: *hcp_test
  id: fetch_exception
  mocks:
    modules.hcp.src.util.HCPManager:
      side_effect: !!python/object/new:Exception ["fetch_exception"]
  logs:
  - Failed to fetch backup for BACKUP (fetch_exception)

- <<: *hcp_test
  id: hcp_merge
  structure:
    modules:
      runner.py: |
        from cellophane import runner, post_hook, pre_hook
        @runner()
        def a(samples, **_):
            return samples

        @runner()
        def b(samples, **_):
            return samples

        @post_hook()
        def check(samples, logger, **_):
            for sample in samples:
              logger.info(f"{sample.id=} {sample.hcp_remote_keys=}")

    samples.yaml: |
      - id: A
        files:
        - input/A
        hcp_remote_keys:
        - A
      - id: B
        files:
        - input/B
        hcp_remote_keys:
        - B
    input:
      A: A
      B: B
  logs:
    - sample.id='A' sample.hcp_remote_keys=['A']
    - sample.id='B' sample.hcp_remote_keys=['B']

- <<: *hcp_test
  id: hcp_length_missmatch
  structure:
    samples.yaml: |
      - id: A
        files:
        - input/A
        hcp_remote_keys:
        - A
        - B
    input:
      A: A
  logs:
    - "Unhandled exception: ValueError('Length mismatch between hcp_remote_keys and files: 2 != 1')"
  exception: SystemExit(1)

- <<: *hcp_test
  id: hcp_order
  structure:
    modules:
      runner.py: |
        from cellophane import runner, post_hook, pre_hook
        @runner()
        def a(samples, **_):
            return samples

        @runner()
        def b(samples, **_):
            return samples

        @post_hook()
        def check(samples, logger, **_):
            for sample in samples:
              logger.info(f"{sample.id=} {sample.hcp_remote_keys=}")

    samples.yaml: |
      - id: A
        files:
        - input/A_0
        - input/A_1
        - input/A_2
        - input/A_3
        - input/A_4
        - input/A_5
        - input/A_6
        - input/A_7
        - input/A_8
        - input/A_9
        hcp_remote_keys:
        - A_0
        - A_1
        - A_2
        - A_3
        - A_4
        - A_5
        - A_6
        - A_7
        - A_8
        - A_9
      - id: B
        files:
        - input/B_0
        - input/B_1
        - input/B_2
        - input/B_3
        - input/B_4
        - input/B_5
        - input/B_6
        - input/B_7
        - input/B_8
        - input/B_9
        hcp_remote_keys:
        - B_0
        - B_1
        - B_2
        - B_3
        - B_4
        - B_5
        - B_6
        - B_7
        - B_8
        - B_9
    input:
      A_0: A
      A_1: A
      A_2: A
      A_3: A
      A_4: A
      A_5: A
      A_6: A
      A_7: A
      A_8: A
      A_9: A
      B_0: B
      B_1: B
      B_2: B
      B_3: B
      B_4: B
      B_5: B
      B_6: B
      B_7: B
      B_8: B
      B_9: B
  logs:
    - sample.id='A' sample.hcp_remote_keys=['A_0', 'A_1', 'A_2', 'A_3', 'A_4', 'A_5', 'A_6', 'A_7', 'A_8', 'A_9']
    - sample.id='B' sample.hcp_remote_keys=['B_0', 'B_1', 'B_2', 'B_3', 'B_4', 'B_5', 'B_6', 'B_7', 'B_8', 'B_9']